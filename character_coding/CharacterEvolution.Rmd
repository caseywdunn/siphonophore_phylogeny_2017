---
title: "## Evolutionary History of Siphonophore Biology"
author: "Alejandro Damian Serrano"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Packages BASIC
library('magrittr')
library('tidyverse')
library('stringr')

#Packages BIO-PHYLO
library('vegan')
library("ape")
library("ggtree")
library("phangorn")
library("phytools")
library("picante")
library("geiger")
library("phylobase")
library("fields")
library("adephylo")
library("geomorph")

#Working directory
setwd("~/Dropbox/siphonophore_phylogeny_2017/character_coding")

#Load data
read.csv('main_characters.csv', header = T, sep = ',') -> cdata
rownames(cdata) = cdata$Species

#Load tree
tree = read.tree('ultimatephylo2017.tre')
tree$tip.label = str_replace_all(tree$tip.label,'_',' ')
tree <- drop.tip(tree, which(!(tree$tip.label %in% rownames(cdata))))
ultratree <- chronos(tree)

#Temporarily prune data
cdata %<>% filter(rownames(.) %in% tree$tip.label)
rownames(cdata) = cdata$Species
cdata %<>% .[-1]

#Named vectors for variables
sex = cdata$Sex
names(sex) = rownames(cdata)

nectosome = cdata$Nectosome
names(nectosome) = rownames(cdata)

necto_pos = cdata$Nectosome.position
names(necto_pos) = rownames(cdata)

necto_types = cdata$Nectophores
names(necto_types) = rownames(cdata)

palpons = cdata$Palpons
names(palpons) = rownames(cdata)

tentilla = cdata$Tentilla
names(tentilla) = rownames(cdata)

pneuma = cdata$Pneumatophore
names(pneuma) = rownames(cdata)

vrange = cdata$Vertical.range
names(vrange) = rownames(cdata)

bracts = cdata$Bract.types
names(bracts) = rownames(cdata)

#Depth pruned data
dpruned_data = cdata[which(!is.na(cdata$Depth.Median)), ]
dpruned_tree <- drop.tip(ultratree, which(!(tree$tip.label %in% rownames(dpruned_data))))
dpruned_data <- dpruned_data[match(dpruned_tree$tip.label, rownames(dpruned_data)),]

depth_median = dpruned_data$Depth.Median
names(depth_median) = rownames(dpruned_data)

depth_mean = dpruned_data$Depth.Mean
names(depth_mean) = rownames(dpruned_data)

depth_min = dpruned_data$Depth.Min
names(depth_min) = rownames(dpruned_data)

depth_max = dpruned_data$Depth.Max
names(depth_max) = rownames(dpruned_data)

depth_sd = dpruned_data$Depth.StdDev
names(depth_sd) = rownames(dpruned_data)

depth_range = depth_max - depth_min

abundance = dpruned_data$Depth.Count
names(abundance) = rownames(dpruned_data)

```

##The Tree:
```{r ultratree, echo=F, message=F, warning=F}
par(ask=F)
par(mfrow=c(1,1))
plotTree(ultratree, lwd = 4)

```

Siphonohores have evolved a fascinating diversity of morphological features, zooid types, life history traits, and habitats. Here we explore the evolutionary history of some of these features.

##Stochastic trait mapping:
```{r simmap_making, echo=F, message=F, warning=F}
#Make simmap objects
print("SIMMAP Sex Distribution")
make.simmap(ultratree, sex, nsim = 100) -> sex_sim
print("SIMMAP Palpons")
make.simmap(ultratree, palpons, nsim = 100) -> palpons_sim
print("SIMMAP Tentilla")
make.simmap(ultratree, tentilla, nsim = 100) -> tentilla_sim
print("SIMMAP Nectosome")
make.simmap(ultratree, nectosome, nsim = 100) -> nectosome_sim
print("SIMMAP Nectosome Position")
make.simmap(ultratree, necto_pos, nsim = 100) -> necto_pos_sim
print("SIMMAP Nectophore Types")
make.simmap(ultratree, necto_types, nsim = 100) -> necto_types_sim
print("SIMMAP Pneumatophore")
make.simmap(ultratree, pneuma, nsim = 100, pts=T) -> pneuma_sim
print("SIMMAP Bract Types")
make.simmap(ultratree, bracts, nsim = 100) -> bracts_sim
print("SIMMAP Habitat")
make.simmap(ultratree, vrange, nsim = 100) -> vrange_sim

```

When we reconstruct the evolutionary history of different traits in siphonophore species, we obtain the following results:

###SIMMAP Sex distribution:
```{r sex, echo=F, message=F,fig.height=7, fig.width=12, warning=F}
#Simmap SEX
plotTree(ultratree, lwd = 4)
sex_sim %>% plotSimmap(lwd = 4, add = T)
colors = c("black", "red")
names(colors) = c("Dioecious", "Monoecious")
nodelabels(pie=(describe.simmap(sex_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
densityMap(sex_sim)
```

Posterior probabilities of states (0 Dioecious, 1 Monoecious).

###SIMMAP Presence of palpons:
```{r palpons, echo=F, message=F,fig.height=7, fig.width=12, warning=F}
#Simmap PALPONS
plotTree(ultratree, lwd = 4)
palpons_sim %>% plotSimmap(lwd = 4, add = T)
colors = c("black", "red")
names(colors) = c("Absent", "Present")
nodelabels(pie=(describe.simmap(palpons_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
densityMap(palpons_sim)
```

Posterior probabilities of states (1 Present, 0 Absent).

###SIMMAP Presence of tentilla:
```{r tentilla, echo=F, message=F,fig.height=7, fig.width=12, warning=F}
#Simmap TENTILLA
plotTree(ultratree, lwd = 4)
tentilla_sim %>% plotSimmap(lwd = 4, add = T)
colors = c("black", "red")
names(colors) = c("Absent", "Present")
nodelabels(pie=(describe.simmap(tentilla_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
densityMap(tentilla_sim)
```

Posterior probabilities of states (1 Present, 0 Absent).

Physalia physalis may have reduced tentilla, which would indicate there was only one loss of tentilla at the branch leading to Apolemia.

###SIMMAP Presence of Nectophores:
```{r nectosome, echo=F, message=F,fig.height=7, fig.width=12, warning=F}
#Simmap NECTOSOME
plotTree(ultratree, lwd = 4)
nectosome_sim %>% plotSimmap(lwd = 4, add = T)
colors = c("black", "red")
names(colors) = c("Absent", "Present")
nodelabels(pie=(describe.simmap(nectosome_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
densityMap(nectosome_sim)
```

Posterior probabilities of states (1 Present, 0 Absent).

###SIMMAP Position of Nectosome:
```{r nectosome_position, echo=F, message=F,fig.height=7, fig.width=12, warning=F}
#SIMMAP NECTOSOME POSITION
plotTree(ultratree, lwd = 4)
necto_pos_sim %>% plotSimmap(lwd = 4, add = T)
colors = c("black", "red", "green")
names(colors) = c("Dorsal", "No nectosome", "Ventral")
nodelabels(pie=(describe.simmap(necto_pos_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
```

###SIMMAP Nectophore number and types:
```{r nectophore_number_types, echo=F, message=F,fig.height=7, fig.width=12, warning=F}
#Simmap NECTOPHORE TYPES
plotTree(ultratree, lwd = 4)
necto_types_sim %>% plotSimmap(lwd = 4, add = T)
colors = c("black", "red", "green", "blue")
names(colors) = c("Multiple of one type", "None", "Two of one type", "Two of two types")
nodelabels(pie=(describe.simmap(necto_types_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
```

###SIMMAP Presence of Pneumatophore:
```{r pneumatophore, echo=F, message=F, warning=F, fig.height=7, fig.width=12}
#Simmap PNEUMATOPHORE
plotTree(ultratree, lwd = 4)
pneuma_sim %>% plotSimmap(lwd = 4, add = T)
colors = c("black", "red")
names(colors) = c("Absent", "Present")
nodelabels(pie=(describe.simmap(pneuma_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
densityMap(pneuma_sim)
```

Posterior probabilities of states (1 Present, 0 Absent).

It is not clear whether or not the stem group of siphonophores had a pneumatophore.

###SIMMAP Number of Bract types:
```{r bract_types, echo=F, fig.height=7, fig.width=12, message=F, warning=F}
#Simmap bract-types
plotTree(ultratree, lwd = 4)
bracts_sim %>% plotSimmap(lwd = 4, add = T) -> bract_sim_plot
#plot(bract_sim_plot[2])
colors = c("black", "red", "green3", "blue")
names(colors) = c("No bracts", "1", "2", "4")
nodelabels(pie=(describe.simmap(bracts_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
```

###SIMMAP Habitat:
```{r depth_zones, echo=F, fig.height=7, fig.width=12, message=F, warning=F}
#Simmap Vertical.Range
plotTree(ultratree, lwd = 4)
vrange_sim %>% plotSimmap(lwd = 4, add = T)
colors = c("black", "cyan", "blue", "green", "red")
names(colors) = c("Bathypelagic", "Surface", "Mesopelagic", "Epipelagic", "Deep benthic")
nodelabels(pie=(describe.simmap(vrange_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
```

##Continuous traits: Brownian motion reconstructions
###Number of bract types reconstruction:
```{r cont_bract_types, echo=F, message=F, warning=F}
contMap(ultratree, bracts)
```
Trait = Number of Bract Types

###Median depth reconstruction:
```{r median_cont, echo=F, message=F, warning=F}
depth_value = depth_median
depthmap <- contMap(dpruned_tree, depth_value, plot=F) %>% setMap(colors=c("cyan","blue","black"))
plot(depthmap)
```

###Bathymetrics phylomorphospace
```{r depth_phylomorpho, echo=F, fig.height=12, fig.width=20, message=F, warning=F}
par(oma=rep(3,4))
phylomorphospace(depthmap$tree, cbind(depth_max, depth_min), xlab="Minimum depth (m)", ylab="Maximum depth (m)", colors=depthmap$cols, fsize=1, label = "horizontal")
```

###Bathymetrics phylomorphospace with time from root as color
```{r depth_phylochronomorpho, echo=F, fig.height=12, fig.width=20, message=F, warning=F}
evotime = fastBM(dpruned_tree,nsim=2)
evotime_map <- contMap(dpruned_tree,evotime[,1], plot=F)
evotime_map$cols[]<-rainbow(1001,start=0.7,end=0)
phylomorphospace(evotime_map$tree, cbind(depth_max, depth_min), xlab="Minimum depth (m)", ylab="Maximum depth (m)", colors=evotime_map$cols, fsize=1, label = "horizontal")
#add.color.bar(2,evotime_map$cols,title="Time from the root", lims=c(0,2000),digits=5)
```

###Abundance of each taxon in the Monterey Bay sampling site
```{r counts_bars, echo=F, message=F, warning=F}
par(oma=rep(1,4))
log_abundance = log(abundance)
log_abundance["Physalia physalis"] = 0
plotBranchbyTrait(dpruned_tree, log_abundance, mode = "tips")
```

###Uncertainty inclusive traitgram for depth range
```{r uncertainty_depth, echo=F, fig.height=14, fig.width=14, message=F, warning=F}
contTrait <- depth_range
A<-fastAnc(dpruned_tree,contTrait,CI=TRUE)
paintree<-paintSubTree(dpruned_tree,node=length(dpruned_tree$tip)+1,"1")
trans<-as.character(floor(0:50/2))
trans[as.numeric(trans)<10]<- paste("0", trans[as.numeric(trans)<10],sep="")
# plot
for(i in 0:50){
  p<-i/length(trans)
  phenogram(dpruned_tree,c(contTrait,(1-p)*A$CI95[,1]+p*A$ace), colors=setNames(paste("#0000ff",trans[i+1],sep=""),1), add=i>0)
  phenogram(dpruned_tree,c(contTrait,(1-p)*A$CI95[,2]+p*A$ace), colors=setNames(paste("#0000ff",trans[i+1],sep=""),1), add=TRUE)
}
phenogram(dpruned_tree,c(contTrait,A$ace),add=TRUE, colors=setNames("black",1))
```

###Bathymetrics scattergram array
```{r depth_scattergram, echo=F, fig.height=11, fig.width=15, message=F, warning=F}
fancyTree(dpruned_tree,type="scattergram",X=cbind(depth_max, depth_min, depth_range, depth_median),control=list(spin=FALSE))
```

###Distribution of sex across siphonophore taxa
```{r ggtree_sex, echo=F, message=F, warning=F}
exp_tree = ultratree
exp_tree$edge.length = 10*ultratree$edge.length
dd = data.frame(taxa  = tree$tip.label, trait = sex[match(tree$tip.label, names(sex))])
p = ggtree(exp_tree, layout="rectangular") + xlim(NA, 23)
p = p %<+% dd + geom_tiplab(aes(color=trait), show_guide = FALSE, size = 3.5) + geom_tippoint(aes(color=trait), alpha=0.25)
p+theme(legend.position="right") + guides(color=guide_legend(title="Sex distribution", reverse=T)) 
```

###Pneumatophore presence across siphonophore taxa
```{r ggtree_pneuma, echo=F, message=F, warning=F}
exp_tree = ultratree
exp_tree$edge.length = 10*ultratree$edge.length
dd = data.frame(taxa  = tree$tip.label, trait = as.factor(pneuma[match(tree$tip.label, names(pneuma))]))
p = ggtree(exp_tree, layout="rectangular") + xlim(NA, 23)
p = p %<+% dd + geom_tiplab(aes(color=trait), show_guide = FALSE, size = 3.5) + geom_tippoint(aes(color=trait), alpha=0.25)
p+theme(legend.position="right") + guides(color=guide_legend(title="Pneumatophore", reverse=T)) 
```

###Tentilla presence across siphonophore taxa
```{r ggtree_tentillq, echo=F, message=F, warning=F}
exp_tree = ultratree
exp_tree$edge.length = 10*ultratree$edge.length
dd = data.frame(taxa  = tree$tip.label, trait = as.factor(tentilla[match(tree$tip.label, names(tentilla))]))
p = ggtree(exp_tree, layout="rectangular") + xlim(NA, 23)
p = p %<+% dd + geom_tiplab(aes(color=trait), show_guide = FALSE, size = 3.5) + geom_tippoint(aes(color=trait), alpha=0.25)
p+theme(legend.position="right") + guides(color=guide_legend(title="Tentilla", reverse=T)) 
```

###Palpon presence across siphonophore taxa
```{r ggtree_palpon, echo=F, message=F, warning=F}
exp_tree = ultratree
exp_tree$edge.length = 10*ultratree$edge.length
dd = data.frame(taxa  = tree$tip.label, trait = as.factor(palpons[match(tree$tip.label, names(palpons))]))
p = ggtree(exp_tree, layout="rectangular") + xlim(NA, 23)
p = p %<+% dd + geom_tiplab(aes(color=trait), show_guide = FALSE, size = 3.5) + geom_tippoint(aes(color=trait), alpha=0.25)
p+theme(legend.position="right") + guides(color=guide_legend(title="Palpons", reverse=T)) 
```

###Overview grid of main binary traits
```{r ggtree_bin_heatmap, echo=F, message=F, warning=F, fig.height=10, fig.width=18}
p <- ggtree(ultratree)
p <- p + geom_tiplab(size=3)
f_cdata = sapply(cdata, as.factor) %>% as.data.frame %>% .[c(2,5:7)]
rownames(f_cdata) = rownames(cdata)
names(f_cdata)[4] = "Float"
gheatmap(p, f_cdata, offset = 0.4, width=0.5, colnames_position = 'top', font.size = 3)
```

##Phylogenetic signal in the character data
Agnostic branch length tree generation:
```{r flat_tree}
flat_tree = tree
flat_tree$edge.length = rep(mean(flat_tree$edge.length), length(flat_tree$edge.length))
```

```{r phylosig_bracts_declare, include=F, echo=F, message=F, warning=F}
physig_bracts_simp = phylosignal(bracts, ultratree)
physig_bracts_mult = physignal(bracts, ultratree)
```
###Phylogenetic signal in bract number
```{r phylosig_bracts, echo=F}
physig_bracts_simp
physig_bracts_mult
```

```{r phylosig_binaries_declare, echo=F, message=F, warning=F, include=F}
binaries_phylosig = multiPhylosignal(as.matrix(cdata[,c(2,5,6,7)]), ultratree)
```
###Phylogenetic signal in Binary Traits
```{r phylosig_binaries, echo=F, message=F, warning=F}
binaries_phylosig
```

```{r phylosig_depth_declare, message=F, warning=F, include=FALSE}
depth_physig = physignal(dpruned_data[,c(13,14,15,17,18)], dpruned_tree)
depth_multisig = multiPhylosignal(dpruned_data[,c(13,14,15,17,18)], dpruned_tree)
```
###Phylogenetic signal in VARS bathymetrics
```{r phylosig_depth, echo=F, message=F, warning=F}
depth_physig
depth_multisig
```

###Phylogenetic PCA for bathymetrics
```{r pPCA_depth, echo=F, fig.height=18, fig.width=18, message=F, warning=F}
phyl.pca(dpruned_tree, dpruned_data[,c(13,14,15,17,18)], mode="corr") %>% biplot
```

###Phylogenetic ANOVA for depth
```{r phylANOVA_depth_declare, echo=F, message=F, warning=F, include=F}
z_nectopos = phylANOVA(dpruned_tree, dpruned_data$Nectosome.position, as.numeric(depth_median))
z_sex = phylANOVA(dpruned_tree, dpruned_data$Sex, as.numeric(depth_median))
z_necto = phylANOVA(dpruned_tree, dpruned_data$Nectosome, as.numeric(depth_median))
z_nectotype = phylANOVA(dpruned_tree, dpruned_data$Nectophores, as.numeric(depth_median))
z_palp = phylANOVA(dpruned_tree, dpruned_data$Palpons, as.numeric(depth_median))
z_tentilla = phylANOVA(dpruned_tree, dpruned_data$Tentilla, as.numeric(depth_median))
z_float = phylANOVA(dpruned_tree, dpruned_data$Pneumatophore, as.numeric(depth_median))
```
Each phylogenetic ANOVA compares variance of depth (continuous variable) within and between groups clustered by their categorical biological traits.
```{r phylANOVA_depth, echo=F, message=F, warning=F}
print("Depth vs Sex Distribution")
z_sex
print("Depth vs Nectosome")
z_necto
print("Depth vs Nectophore Types and Number")
z_nectotype
print("Depth vs Nectosome Position")
z_nectopos
print("Depth vs Palpons")
z_palp
print("Depth vs Tentilla")
z_tentilla
print("Depth vs Pneumatophore")
z_float
```