---
bibliography: manuscript.bib
csl: systematic-biology.csl
output:
  pdf_document:
    fig_caption: yes
---


```{r preliminaries, include=FALSE}
	# Load packages

	# General
	library( tidyverse )
	library( stringr )
	library( forcats )
  library( magrittr )
	library( digest )
	library( knitr )
	library( jsonlite )
	library( parallel )

	# Formatting
  library( xtable )

	# Graphics
	library( cowplot )
	library( ggtree )
	library( fields ) # tim.colors
	library( seriation )
	library( gridExtra )
  library( factoextra )
  library( FactoMineR )

	# Biological
	library( hutan )	# https://github.com/caseywdunn/hutan
	library( ape )
	library( picante )  # cor.table
	library( phytools ) # phylosig
  library( vegan )
  library( ggtree )
  library( phangorn )
  library( geiger )
  library( phylobase )
  library( adephylo )
  library( geomorph ) #physig
  library( phylolm )

	# Configure knitr, see http://yihui.name/knitr/options
	opts_knit$set( 
	  progress=TRUE, 
	  verbose=TRUE)
	
	opts_chunk$set(
	#  include=FALSE, 
	  cache=TRUE,
	  echo=FALSE,
	  message=FALSE
	 )

	# Set system computational parameters
	cores = detectCores() - 1
	if ( cores < 1 ) {
		cores = 1
	}
	set.seed( 23456 )

	# Set paths to input data
	tree_path = "agalma/Outfiles/"
	input_file_ml = paste( tree_path, "RAxML_bipartitions.alignment.fa", sep="" )
	input_file_bootstraps = paste( tree_path, "RAxML_bootstrap.alignment.fa", sep="" )
	
	input_files_phylobayes = list.files( 
	  path=tree_path, 
	  pattern="chain\\d+_trimmed60_poisson.treelist" 
	 )
	
	# Analysis parameters
	burn_in = 400

```

```{r functions}

  get_node_support = function(  tree, treeset, threshold=100 ){
    # Returns a vector corresponding to nodes in tree, with percent of trees 
    # in treeset that contain the corresponding bipartition
    clades = prop.clades(tree, treeset) / length(treeset)
    nodes = c(rep(NA,length(tree$tip.label)), round(clades*100)) # Offset with NA values for tips
    nodes[ length(tree$tip.label) + 1 ] = NA # Set the root value to NA, not a robust way to find root but works in this case
    
    nodes[ nodes >= threshold  ] = NA
    
    return(nodes)
  }

  fix_names = function( tree ){
    # Apply changes to any tip names
    tree$tip.label = sub( '_', ' ', tree$tip.label ) # Change first underscore to space
    tree$tip.label = sub( 'sp_', 'sp', tree$tip.label ) # Fix trailing _ in Physonect sp_
    return( tree )
  }

```



```{r load_data}

	species_tree = ape::read.tree( input_file_ml )
  species_tree = fix_names( species_tree )

  bootstrap_trees = ape::read.tree( input_file_bootstraps )
  
  phylobayes_trees = sapply(
    input_files_phylobayes,
    function( pb ) {
      ape::read.tree( 
        paste( tree_path, pb, sep = "" ) 
      )[ -(1:burn_in)  ]
    }
  )
  
  phylobayes_trees = unlist( phylobayes_trees,recursive=FALSE )
  class( phylobayes_trees  ) = "multiPhylo"
  
  bootstrap_trees = lapply( bootstrap_trees, fix_names )
  phylobayes_trees = lapply( phylobayes_trees, fix_names )

```

```{r pre_process_species_trees}

	species_tree = ape::ladderize( species_tree )

	species_tree = 
	  ape::root( 
	    species_tree, 
	    c( "Nematostella vectensis", "Aiptasia pallida" ), 
	    resolve.root=TRUE 
	   )

  
  # Repartition length of edges descended from root so they are non-zero
	species_tree = hutan::slide_root_edges( species_tree )

	# species_tree = ape::unroot(species_tree)

	stopifnot( species_tree$Nnode == length( species_tree$node.label ) )

	
	# Make ultrametric tree
	# By default, root has a depth of 1
	species_ultrametric = chronos( species_tree, lambda=1, model="correlated", quiet=TRUE )
	class( species_ultrametric ) = "phylo"

```


# Siphonophore Phylogeny

Stefan Siebert^1,2^, Felipe Zapata^1,3^, Mark Howison^4^, Cat Munro^1^, Alejandro Damian Serrano^1^, Samuel H Church^1, 5^, Freya Goetz^1,5^, Phil Pugh, Steven H.D. Haddock^4^, Casey W. Dunn^1^*

^1^ Department of Ecology and Evolutionary Biology, Brown University, Providence, RI, USA

^2^ Current address: Department of Molecular & Cellular Biology, University of California at Davis, Davis, CA, USA

^3^ Current address: Department of Ecology and Evolutionary Biology, University of California Los Angeles, Los Angeles, CA, USA

^4^ Brown Data Science Practice, Brown University, Brown University, Providence, RI, USA

^5^ Harvard

^5^ Current address: Smithsonian, Washington DC, USA

^4^ Monterey Bay Aquarium Research Institute, Moss Landing, CA, USA


\* Corresponding author, casey_dunn@brown.edu

## Abstract

## Introduction

Siphonophores are...


## Methods

This manuscript is an executable document computed directly from the data, providing an explicit and reproducible description of all findings. All scripts for the analyses are available in a git repository at [https://github.com/caseywdunn/siphonophore_phylogeny_2017](https://github.com/caseywdunn/siphonophore_phylogeny_2017). The most recent commit at the time of the analysis presented here was `r system("git log | head -n 1", intern=TRUE) %>% str_replace("commit ", "")`.


#### Collecting

Collection data on all examined specimens, a description of the tissue that was sampled from the colony, collection mode, sample processing details, mRNA extraction methods, sequencing library preparation methods and sequencing details are summarized in supplementary table 1. Monterey Bay and Gulf of California specimens were collected by remotely operated underwater vehicle (ROV) or during blue-water scuba dives. *Chelophyes appendiculata* and *Hippopodius hippopus* specimens were collected in the bay of Villefranche-sur-Mer, France, during a plankton trawl on 04/13/11. Available physical vouchers have been deposited at the Museum of Comparative Zoology (Harvard University), Cambridge, MA, and at the United States National Museum (Smithsonian Institution), Washington, DC. Accession numbers are given in supplementary table X. In cases where physical vouchers were unavailable we provide photographs to document species identity (table x).


#### Sequencing

When possible specimens were starved overnight in filtered seawater at temperatures close to ambient water temperatures at the time point of specimen collection (supplementary table 1). mRNA was extracted directly from tissue using a variety of methods (supplementary table x): Magnetic mRNA Isolation Kit (NEB, #S1550S), Invitrogen Dynabeads mRNA Direct Kit (Ambion, #61011), Qymo Quick RNA MicroPrep (Zymo #R1050), or from total RNA after Trizol (Ambion, #15596026) extraction and through purification using Dynabeads mRNA Purification Kit (Ambion, #61006)-  in case of very small total RNA quantities, only a single round of bead purification was performed; or Trizol directly into the Illumina TruSeq Stranded Library Kit. Extractions were performed according to the manufacturer's instruction.  Any resulting higher rRNA read counts were dealt with further downstream in the bioinformatics workflow. Libraries were prepared for sequencing using the Illumina TruSeq RNA Sample Prep Kit (Illumina, #FC-122-1001, #FC-122-1002), the Illumina TruSeq Stranded Library Prep Kit (Illumina, #RS-122-2101) or the NEBNext RNA Sample Prep Master Mix Set (NEB, #E6110S). We collected long read paired end Illumina data for *de novo* transcriptome assembly.In the case of large tissue inputs, libraries were sequenced separately for each tissue and subsequently were subsampled and pooled *in silico*. Libraries were sequenced on the HiSeq 2000, 2500, and 3000 sequencing platforms (supplementary table 1). Summary statistics for expression libaries are given in Table 1.


#### Analysis

New data were analysed in conjunction with 13 publically available datasets, with a total number of 43 species. Sequence assembly, annotation, Maximum Likelihood (ML) phylogenetic analysis were conducted with the tool Agalma [@Dunn:2013kw], v. 1.00, and Bayesian Inference (BI) analyses were conducted using Phylobayes[@lartillot2009phylobayes] v. 1.7a-mpi. Source code for all analysis steps, sequence alignments, sampled and consensus trees, and voucher information are available in a git repository https://github.com/caseywdunn/siphonophore_phylogeny_2017.  

In the final analyses, we sampled 1,071 genes to generate a supermatrix with 60% occupancy and a length of 378,468 amino acids. Two outgroup species, *Atolla vanhoeffeni* and *Aegina citrea*, were removed from the final supermatrix and phylogeny due to low gene occupancy (gene sampling of 20.8% and 14.5% respectively in a 50% occupancy matrix with 2,203 genes). ML analyses were conducted on the unpartitioned supermatrix using the WAG+$\gamma$ model of amino acid substitution, and bootstrap values were estimated using 1000 replicates. BI was conducted using two different CAT models, CAT-Poisson and CAT-GTR [@doi:10.1093/molbev/msh112]. Two independent MCMC chains were run under the CAT-GTR model, and four independent MCMC chains were run under the CAT-Poisson model. The CAT-GTR and CAT-poisson models did not converge after a long CPU time, and only the results from the CAT-poisson model are included here.

Subsequent analyses were conducted in R and integrated into this manuscript with the `knitr` package. See Supplementary Information for R package version numbers.

#### Hypothesis testing


## Results and Discussion

### Sample collecting and sequencing

```{r summary_table, results='asis', echo=FALSE, comment=NA, warning=FALSE}



```
Table 1 (at the end of file): Summary statistics for libraries.


### Species phylogeny

```{r species_phylogram, echo=FALSE, comment=NA, warning=FALSE, fig.width=6.5, fig.height=7, fig.cap="Phylogram of siphonophore relationships. Node labels indicate bootstrap support percent, unnumbered nodes have 100% support. The image was rendered with ggtree [@Yu:2016fo]" }

	siphonophora_node = ape::mrca( species_tree )[ "Physalia physalis", "Agalma elegans" ]
	cystonectae_node = ape::mrca( species_tree )[ "Physalia physalis", "Rhizophysa filiformis" ]
	calycophora_node = ape::mrca( species_tree )[ "Kephyes ovata", "Hippopodius hippopus" ]
	euphysonectae_node = ape::mrca( species_tree )[ "Agalma elegans", "Erenna richardi" ]

	support = as.numeric( species_tree$node.label )
	support[ support > 99 ] = NA

	# pad tip values
	support = c( rep( NA, length( species_tree$tip.label ) ), support )
  
	
	
	
	p_phylogram = ggtree( species_tree ) +
			# geom_text( aes( label=support ), vjust=-.5, hjust=1, size=2.5, col="darkslategray4" ) +
	    geom_text(aes(label=get_node_support(species_tree, bootstrap_trees)), vjust=-.5, hjust=1, size=2.5, col="red") +
      geom_text(aes(label=get_node_support(species_tree, phylobayes_trees)), vjust=1.5, hjust=1, size=2.5, col="blue") +
			geom_tiplab( size=3 ) +
			xlim( NA, 4 ) +
			geom_cladelabel( node=cystonectae_node, label="Cystonectae", align=FALSE, offset=1, color='red' ) +
			geom_cladelabel( node=calycophora_node, label="Calycophora", align=FALSE, offset=1, color='blue' ) +
			geom_strip(
				which( species_tree$tip.label=="Agalma elegans" ),
				which( species_tree$tip.label=="Apolemia white" ),
				barsize=0.5,
				color='orange',
				offset=1,
				label='"Physonectae"'
			) +
			geom_strip(
				which( species_tree$tip.label=="Hydractinia symbiolongicarpus" ),
				which( species_tree$tip.label=="Nematostella vectensis" ),
				barsize=0.5,
				color='gray',
				offset=1,
				label='"Outgroups"'
			)

	flip( p_phylogram, euphysonectae_node, calycophora_node )

```


(XX This paragraph on sampling through Agalma analyses) The analyses presented here consider XXX siphonophore species and 8 outgroup species. This includes new data for XXX species. Summary stats on assemblies XX (Table XX). Matrix has XX genes, XX sites, and occupancy is XX. 

(XX This paragraph on summarizes phylogeny runs, apart from tree topology) Maximimum likelihood analyses had `r length(bootstrap_trees)` replicates. We ran `r length( input_files_phylobayes )` phylobayes chains, and visual inspection of the traces indicated that a burn in of `r burn_in` trees was sufficient for all runs. This left `r length( phylobayes_trees )` trees in the posterior. XXConvergence...

These findings are entirely consistent with a previous analysis based on two genes (16S and 18S ribosomal RNA) [@Dunn:2005dy]. Cystonectae is the sister group to the remaining siphonophores, and Calycophorae is nested within the paraphyletic "Physonectae". In addition, multiple nodes that were not resolved in the previous two-gene analysis do recieve strong support in this 1,071-gene transcriptome analysis. These findings include XXX.

## Character Evolution

Siphonohores have evolved a fascinating diversity of morphological features, zooid types, life history traits, and habitats. Here we explore the evolutionary history of some of these features. 

In our previous siphonophore phylogenetic analysis [@Dunn:2005dy] there were several characters left with equivocal evolutionary histories, due to unresolved relationships between physonects. With our current cladistic resolution, we were able to determine the following results:

###Evolution of Monoecy

[Citation needed] noticed for the first time that some siphonophores were monoeicous and others were dioiecious. Our analyses in 2005 reconstructed this character and found a great amount of phylogenetic conservatism, with an unambiguous resolution of the MRCA as dioecious, and the appearance of monoecy in several taxa and clades (including Calycophorae) within the polytomy. Figure X shows the evolution of sex distribution in siphonophores under the current better-resolved tree model, and it strongly indicates that monoecy in siphonophores from a dioecious ancestor occured twice, in the branch leading to Calycophorae and in the branch leading to Agalmatids (sensu lato). There is a small probability for an alternative scenario featuring a single gain of monoecy before the split of Calycophorae, with a subsequent derived shift back to dioecy in the *Marrus-Erenna* clade.

###The Evolution of Zooid Types

One of the most striking aspects of siphonophore biology is their diversity of unique zooid types. Other colonial cnidarians (such as Hydractinia) and some bryozoans (example) have been found to have up to X different zooid types [Citation1 , Citation 2]. The siphonophore genus Forskalia has 6 basic zooid types (pneumatophore, nectophore, gastrozooid, palpon, bract, and gonophore), and a total of 10 counting subtypes (4 types of bract, male & female gonophores). Diphyomorphs have more than 1 type of nectophore, while Cystonects have none. Here we reconstruct the evolutionary origins ofthe different zooid types and subtypes on the present transcriptome tree.

Nectophores are retained modified medusae Codonophora use for swimming. The nectosome is the region of the colony that develops from the nectosomal growth zone. Unlike the siphosomal growth zone, the nectosome does not bud gastrozooids, but nectophores (and in the case of *Apolemia*, also palpons). If fact, with the exception of  *Physalia physalis* (which grows small nectophores near the gonodendra), siphonophore nectophores are exclusively found on the nectosome. It is likely that the MRCA of siphonophores had a nectosome, which has lost on the branch leading to Cystonects. We cannot exclude with certainty the alternative hypothesis of a nectosome-less ancestor followed by a gain of the nectosome in the branch leading to the Codonophora. The nectosome probably arose as a duplication of the siphosome, followed by functional specialization in propelling the colony. Figure X shows the origin of the dorsal nectosome in the Agalmatidae (sensu stricto) from an ancestral ventral nectosome. 

All Codonophora have a nectosome, but the number and subtypes of nectophores present varies greatly between species. As shown in Figure X, most Codonophora presents the ancestral nectosome with multiple nectophores of the same subtype. However, Calycophorans evolved a different system with just 2 nectophores of one type. This shift may be associated with the loss of the pneumatophore. Not all Calycophorans remained with this arrangement. The Hippopodiidae returned to bearing multiple identical nectophores, many of which are inactive and serve functions of defense (like a shell to retract in) and buoyancy. As in the rest of Calycophorans, the Hippopiids only use 2 nectophores to propel the colony. Another interesting shift occurs in the branch leading to Diphyomorpha, where the 2 nectophores specialize into 2 subtypes, associated with a shift into a vertically aligned position and pointed bell shapes. The 2 types function together in a coupled hydrodynamic system that allows very fast escape responses (Mackie 1964).

Bracts also present a complex evolutionary history of subtypes (Figure X). Bracts are highly reduced zooids unique to siphonophores, but they are only present in the Codonophora. As with the nectosome, we have ambiguity determining whether the MRCA of siphonophores had bracts or not. The MRCA of Codonophora ahd only one bract subtype, which was lost in Hippopodiidae and independently evolved into 2 subtypes in *Erenna* and *Nanomia*. During the branch leading to Forskalidae, bract subtypes evolved from 1 to 4 morphologically distinct forms. Bracts are important for protection of the delicate zooids and to help maintain neutral buoyancy. Some calycophorans are able to actively regulate the Na/NH4 balance to adjust their buoyancy (ref).

The ancestral siphonophore certainly had a pneumatophore (Figure X). This zooid type helps the colony float, maintain its pose, and regulate geotaxis (Church, 2013). Despite its diverse biological functions, it is lost in Calycophorae and never gained again in that clade. Calycophorans rely on the ionic balance of their gelatinous nectophores and bracts to retain posture and neutral buoyancy.

Palpons are modified mouthless gastrozooids used for digestion and circulation of the gastrovascular fluid. They were present in the MRCA of siphonophores (Figure X), retained in most species, but lost twice independently in the branches leading to *Bargmannia* and Calycophorae. These taxa must have found other avenues to effectively circulate nutrients across the colony.

###The Gain and Loss of Tentilla

The most complex nematocyst batteries of Cnidaria can arguably be found among the siphonophores, hanging in regularly spaced tentacle side branches called tentilla. Most hydrozoans, including the clade that contains siphonophores, bear simple tentacles (tentacles with no side branches). Is is still an open question whether the most recent common ancestor (MRCA) of Siphonophora had simple or branched tentacles. The only two siphonophore genera regarded as lacking tentilla are *Physalia* and *Apolemia*, at each side of the earliest split in the siphonophore tree, with an immediate sister group with most members bearing tentilla (*Rhizophysidae* with the exception of *Bathyphysa conifera* and *{Bargmannia, Diphyes}*) (FigXX). Figure X shows the evolution of this character on the current phylogeny, indicating a most-likely tentilla bearing MRCA, with two independent losses. However, this reconstruction bears some uncertainty on the state of the MRCA, suggesting a ~30% probability of 2 independent gains of tentilla in the branches leading to *Rhizophysidae* and *{Bargmannia, Diphyes}*.

A key issue here is how we code for absence of tentilla, especially for the case of *Physalia physalis*. The tentacles of this species, when uncoiled, show very prominent, evenly spaced, 3D buttons which contain all active and functionally arranged nematocysts used by the organism for prey capture. Siphonophore tentilla are complete diverticular brachings of the tentacle ectoderm, mesoglea, and gastrovascular canal (lined by endoderm). Hessinger & Ford 1988 (in the Biology of Nematocysts) described these bands as enclosing individual fluid-filled chambers connected by narrow channels to the tentacular canal, lined by endoderm. This suggests they are not just ectodermal swellings, but probably are reduced tentilla. When we code *Physalia physalis* as tentilla bearing, the results for the character reconstraction change to a more parsimonious scenario (Figure X), indicating there was a single loss of tentilla in the branch leading to *Apolemiidae*. This result suggests an unambiguous tentilla-bearing state of the MRCA.

###The Evolution of Vertical Habitat Use

Siphonophores are abundant predators in the pelagic realm, ranging from the surface (*Physalia physalis*) to bathypelagic depths (ref , *Bargmannia sp* 3888m VARS unpublished). While there are some pleustonic (*Physalia*) and benthic (*Rhodaliidae*) siphonophores, the phylogeny suggests the siphonophore MRCA was planktonic, as most extant taxa are. Some interesting questions arise from these facts, including 1) what was the bathymetric niche of the siphonophore MRCA, and 2) how did siphonophore's vertical habitat use of the water columns evolve along the phylogeny. Our results indicate a mesopelagic MRCA, with several convergent transition events to epipelagic and bathypelagic waters. There was only a single transition to benthic lifestyle on the stem of *Rhodaliidae*.

##Discussion


The strong phylogenetic signal in the characters traditinally used for taxonomic diagnostics is a positive indicator of the applicability and unambiguity of these characters.

## Conclusions


## Acknowledgements

This work was supported by the National Science Foundation (DEB-1256695 and the Waterman Award). Sequencing at the Brown Genomics Core facility was supported in part by NIH P30RR031153 and NSF EPSCoR EPS-1004057. Data transfer was supported by NSF RII-C2 EPS-1005789. Analyses were conducted with computational resources and services at the Center for Computation and Visualization at Brown University, supported in part by the NSF EPSCoR EPS-1004057 and the State of Rhode Island. We also thank the MBARI crews and ROV pilots for collection of the specimens.



## Supplementary Information



### Supplementary Analyses

```{r char_evo_setup, include=F, echo=F}

#Load data
read.csv('character_coding/main_characters.csv', header = T, sep = ',') -> cdata
rownames(cdata) = cdata$Species

#Load tree
tree = species_ultrametric
tree$tip.label = str_replace_all(tree$tip.label,'_',' ')
tree <- drop.tip(tree, which(!(tree$tip.label %in% rownames(cdata))))
ultratree <- chronos(tree)
class( ultratree ) = "phylo"

#Temporarily prune data
cdata %<>% filter(rownames(.) %in% tree$tip.label)
rownames(cdata) = cdata$Species
cdata %<>% .[-1]

#Named vectors for variables
sex = cdata$Sex
names(sex) = rownames(cdata)

nectosome = cdata$Nectosome
names(nectosome) = rownames(cdata)

necto_pos = cdata$Nectosome.position
names(necto_pos) = rownames(cdata)

necto_types = cdata$Nectophores
names(necto_types) = rownames(cdata)

palpons = cdata$Palpons
names(palpons) = rownames(cdata)

tentilla = cdata$Tentilla
names(tentilla) = rownames(cdata)

tentilla2 = tentilla
tentilla2['Physalia physalis'] = 1 #In the scenario where we consider Physalias knobs reduced not lost tentilla

vrange = cdata$Vertical.range
names(vrange) = rownames(cdata)

#Depth pruned data
dpruned_data = cdata[which(!is.na(cdata$Depth.Median)), ]
dpruned_tree <- drop.tip(ultratree, which(!(tree$tip.label %in% rownames(dpruned_data))))
dpruned_data <- dpruned_data[match(dpruned_tree$tip.label, rownames(dpruned_data)),]

depth_median = dpruned_data$Depth.Median
names(depth_median) = rownames(dpruned_data)

depth_mean = dpruned_data$Depth.Mean
names(depth_mean) = rownames(dpruned_data)

depth_min = dpruned_data$Depth.Min
names(depth_min) = rownames(dpruned_data)

depth_max = dpruned_data$Depth.Max
names(depth_max) = rownames(dpruned_data)

depth_sd = dpruned_data$Depth.StdDev
names(depth_sd) = rownames(dpruned_data)

depth_range = depth_max - depth_min

abundance = dpruned_data$Depth.Count
names(abundance) = rownames(dpruned_data)

```

The Tree:
```{r ultratree, echo=F, message=F, warning=F}
par(ask=F)
par(mfrow=c(1,1))
plotTree(ultratree, lwd = 4)

```

Stochastic trait mapping:
```{r simmap_making, echo=F, message=F, warning=F}
#Make simmap objects
print("SIMMAP Sex Distribution")
make.simmap(ultratree, sex, nsim = 100, message=FALSE) -> sex_sim
print("SIMMAP Palpons")
make.simmap(ultratree, palpons, nsim = 100, message=FALSE) -> palpons_sim
print("SIMMAP Tentilla")
make.simmap(ultratree, tentilla, nsim = 100, message=FALSE) -> tentilla_sim
print("SIMMAP Tentilla2")
make.simmap(ultratree, tentilla2, nsim = 100, message=FALSE) -> tentilla_sim2
print("SIMMAP Nectosome")
make.simmap(ultratree, nectosome, nsim = 100, message=FALSE) -> nectosome_sim
print("SIMMAP Nectosome Position")
make.simmap(ultratree, necto_pos, nsim = 100, message=FALSE) -> necto_pos_sim
print("SIMMAP Nectophore Types")
make.simmap(ultratree, necto_types, nsim = 100, message=FALSE) -> necto_types_sim
print("SIMMAP Habitat")
make.simmap(ultratree, vrange, nsim = 100, message=FALSE) -> vrange_sim

```

When we reconstruct the evolutionary history of different traits in siphonophore species, we obtain the following results:

SIMMAP Sex distribution:
```{r sex, echo=F, message=F, warning=F}
#Simmap SEX
plotTree(ultratree, lwd = 4)
colors = c("black", "red")
names(colors) = c("Dioecious", "Monoecious")
sex_sim %>% plotSimmap(lwd = 4, add = T, colors=colors)
nodelabels(pie=(describe.simmap(sex_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
densityMap(sex_sim)
```

Posterior probabilities of states (0 Dioecious, 1 Monoecious).

SIMMAP Presence of palpons:
```{r palpons, echo=F, message=F, warning=F}
#Simmap PALPONS
plotTree(ultratree, lwd = 4)
colors = c("black", "red")
names(colors) = c("Absent", "Present")
palpons_sim %>% plotSimmap(lwd = 4, add = T,colors=colors)
nodelabels(pie=(describe.simmap(palpons_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
densityMap(palpons_sim)
```

Posterior probabilities of states (1 Present, 0 Absent).

SIMMAP Presence of tentilla:
```{r tentilla, echo=F, message=F,warning=F}
#Simmap TENTILLA
plotTree(ultratree, lwd = 4)
colors = c("black", "red")
names(colors) = c("Absent", "Present")
tentilla_sim %>% plotSimmap(lwd = 4, add = T,colors=colors)
nodelabels(pie=(describe.simmap(tentilla_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
densityMap(tentilla_sim)
```

Posterior probabilities of states (1 Present, 0 Absent).

*Physalia physalis* may have reduced tentilla, which would indicate there was only one loss of tentilla at the branch leading to *Apolemia*.

SIMMAP Presence of tentilla - *Physalia* corrected:
```{r tentilla2, echo=F, message=F, warning=F}
#Simmap TENTILLA
plotTree(ultratree, lwd = 4)
colors = c("black", "red")
names(colors) = c("Absent", "Present")
tentilla_sim2 %>% plotSimmap(lwd = 4, add = T,colors=colors)
nodelabels(pie=(describe.simmap(tentilla_sim2, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
densityMap(tentilla_sim2)
```

Posterior probabilities of states (1 Present, 0 Absent).

SIMMAP Presence of Nectophores:
```{r nectosome, echo=F, message=F, warning=F}
#Simmap NECTOSOME
plotTree(ultratree, lwd = 4)
colors = c("black", "red")
names(colors) = c("Absent", "Present")
nectosome_sim %>% plotSimmap(lwd = 4, add = T,colors=colors)
nodelabels(pie=(describe.simmap(nectosome_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
densityMap(nectosome_sim)
```

Posterior probabilities of states (1 Present, 0 Absent).

SIMMAP Position of Nectosome:
```{r nectosome_position, echo=F, message=F, warning=F}
#SIMMAP NECTOSOME POSITION
plotTree(ultratree, lwd = 4)
colors = c("black", "red", "green")
names(colors) = c("Dorsal", "No nectosome", "Ventral")
necto_pos_sim %>% plotSimmap(lwd = 4, add = T,colors=colors)
nodelabels(pie=(describe.simmap(necto_pos_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
```

SIMMAP Nectophore number and types:
```{r nectophore_number_types, echo=F, message=F, warning=F}
#Simmap NECTOPHORE TYPES
plotTree(ultratree, lwd = 4)
colors = c("black", "red", "green", "blue")
names(colors) = c("Multiple of one type", "None", "Two of one type", "Two of two types")
necto_types_sim %>% plotSimmap(lwd = 4, add = T,colors=colors)
nodelabels(pie=(describe.simmap(necto_types_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
```

Posterior probabilities of states (1 Present, 0 Absent).

It is not clear whether or not the stem group of siphonophores had a pneumatophore.

SIMMAP Habitat:
```{r depth_zones, echo=F, message=F, warning=F}
#Simmap Vertical.Range
plotTree(ultratree, lwd = 4)
colors = c("black", "cyan", "blue", "green", "red")
names(colors) = c("Bathypelagic", "Surface", "Mesopelagic", "Epipelagic", "Deep benthic")
vrange_sim %>% plotSimmap(lwd = 4, add = T,colors=colors)
nodelabels(pie=(describe.simmap(vrange_sim, plot=F)$ace) ,piecol=colors,cex=0.35)
add.simmap.legend(colors = colors, x=0.6*par()$usr[1],y=0.3*par()$usr[4],prompt=FALSE)
```

Continuous traits: Brownian motion reconstructions

Median depth reconstruction:
```{r median_cont, echo=F, message=F, warning=F}
depth_value = depth_median
depthmap <- contMap(dpruned_tree, depth_value, plot=F) %>% setMap(colors=c("cyan","blue","black"))
plot(depthmap)
```

Bathymetrics phylomorphospace
```{r depth_phylomorpho, echo=F, message=F, warning=F}
par(oma=rep(3,4))
phylomorphospace(depthmap$tree, cbind(depth_max, depth_min), xlab="Minimum depth (m)", ylab="Maximum depth (m)", colors=depthmap$cols, fsize=1, label = "horizontal")
```

Bathymetrics phylomorphospace with time from root as color
```{r depth_phylochronomorpho, echo=F, message=F, warning=F}
evotime = fastBM(dpruned_tree,nsim=2)
evotime_map <- contMap(dpruned_tree,evotime[,1], plot=F)
evotime_map$cols[]<-rainbow(1001,start=0.7,end=0)
phylomorphospace(evotime_map$tree, cbind(depth_max, depth_min), xlab="Minimum depth (m)", ylab="Maximum depth (m)", colors=evotime_map$cols, fsize=1, label = "horizontal")
#add.color.bar(2,evotime_map$cols,title="Time from the root", lims=c(0,2000),digits=5)
```

Abundance of each taxon in the Monterey Bay sampling site
```{r counts_bars, echo=F, message=F, warning=F}
par(oma=rep(1,4))
log_abundance = log(abundance)
log_abundance["Physalia physalis"] = 0
plotBranchbyTrait(dpruned_tree, log_abundance, mode = "tips")
```

Uncertainty inclusive traitgram for depth range
```{r uncertainty_depth, echo=F, message=F, warning=F}
contTrait <- depth_range
A<-fastAnc(dpruned_tree,contTrait,CI=TRUE)
paintree<-paintSubTree(dpruned_tree,node=length(dpruned_tree$tip)+1,"1")
trans<-as.character(floor(0:50/2))
trans[as.numeric(trans)<10]<- paste("0", trans[as.numeric(trans)<10],sep="")
# plot
for(i in 0:50){
  p<-i/length(trans)
  phenogram(dpruned_tree,c(contTrait,(1-p)*A$CI95[,1]+p*A$ace), colors=setNames(paste("#0000ff",trans[i+1],sep=""),1), add=i>0)
  phenogram(dpruned_tree,c(contTrait,(1-p)*A$CI95[,2]+p*A$ace), colors=setNames(paste("#0000ff",trans[i+1],sep=""),1), add=TRUE)
}
phenogram(dpruned_tree,c(contTrait,A$ace),add=TRUE, colors=setNames("black",1))
```

Bathymetrics scattergram array
```{r depth_scattergram, echo=F, message=F, warning=F}
fancyTree(dpruned_tree,type="scattergram",X=cbind(depth_max, depth_min, depth_range, depth_median),control=list(spin=FALSE))
```

Distribution of sex across siphonophore taxa
```{r ggtree_sex, echo=F, message=F, warning=F}
exp_tree = ultratree
exp_tree$edge.length = 10*ultratree$edge.length
dd = data.frame(taxa  = tree$tip.label, trait = sex[match(tree$tip.label, names(sex))])
p = ggtree(exp_tree, layout="rectangular") + xlim(NA, 23)
p = p %<+% dd + geom_tiplab(aes(color=trait), show_guide = FALSE, size = 3.5) + geom_tippoint(aes(color=trait), alpha=0.25)
p+theme(legend.position="right") + guides(color=guide_legend(title="Sex distribution", reverse=T)) 
```

Tentilla presence across siphonophore taxa
```{r ggtree_tentillq, echo=F, message=F, warning=F}
exp_tree = ultratree
exp_tree$edge.length = 10*ultratree$edge.length
dd = data.frame(taxa  = tree$tip.label, trait = as.factor(tentilla[match(tree$tip.label, names(tentilla))]))
p = ggtree(exp_tree, layout="rectangular") + xlim(NA, 23)
p = p %<+% dd + geom_tiplab(aes(color=trait), show_guide = FALSE, size = 3.5) + geom_tippoint(aes(color=trait), alpha=0.25)
p+theme(legend.position="right") + guides(color=guide_legend(title="Tentilla", reverse=T)) 
```

Palpon presence across siphonophore taxa
```{r ggtree_palpon, echo=F, message=F, warning=F}
exp_tree = ultratree
exp_tree$edge.length = 10*ultratree$edge.length
dd = data.frame(taxa  = tree$tip.label, trait = as.factor(palpons[match(tree$tip.label, names(palpons))]))
p = ggtree(exp_tree, layout="rectangular") + xlim(NA, 23)
p = p %<+% dd + geom_tiplab(aes(color=trait), show_guide = FALSE, size = 3.5) + geom_tippoint(aes(color=trait), alpha=0.25)
p+theme(legend.position="right") + guides(color=guide_legend(title="Palpons", reverse=T)) 
```

Overview grid of main binary traits
```{r ggtree_bin_heatmap, echo=F, message=F, warning=F}
p <- ggtree(ultratree)
p <- p + geom_tiplab(size=3)
f_cdata = sapply(cdata, as.factor) %>% as.data.frame %>% .[c(2,5:7)]
rownames(f_cdata) = rownames(cdata)
names(f_cdata)[4] = "Float"
gheatmap(p, f_cdata, offset = 0.4, width=0.5, colnames_position = 'top', font.size = 3)
```

Phylogenetic signal in the character data
Agnostic branch length tree generation:
```{r flat_tree}
flat_tree = tree
flat_tree$edge.length = rep(mean(flat_tree$edge.length), length(flat_tree$edge.length))
```

```{r phylosig_binaries_declare, echo=F, message=F, warning=F, include=F}
binaries_phylosig = multiPhylosignal(as.matrix(cdata[,c(2,5,6,7)]), ultratree)
```
Phylogenetic signal in Binary Traits
```{r phylosig_binaries, echo=F, message=F, warning=F}
binaries_phylosig
```

```{r phylosig_depth_declare, message=F, warning=F, include=FALSE}
depth_physig = physignal(dpruned_data[,c(14,15,16,18,19)], dpruned_tree)
depth_multisig = multiPhylosignal(dpruned_data[,c(14,15,16,18,19)], dpruned_tree)
```
Phylogenetic signal in VARS bathymetrics
```{r phylosig_depth, echo=F, message=F, warning=F}
depth_physig
depth_multisig
```

Phylogenetic PCA for bathymetrics
```{r pPCA_depth, echo=F, message=F, warning=F}
phyl.pca(dpruned_tree, dpruned_data[,c(14,15,16,18,19)], mode="corr") %>% biplot

dpruned_data[,c(14,15,16,18,19)] %>% PCA(graph=F) -> Zpca
Zpca %>% fviz_screeplot(addlabels=T)
Zpca %>% fviz_contrib(choice="var", axes=1, sort.val="desc")
Zpca %>% fviz_pca_biplot( col.var="contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), repel = TRUE)

phyl.pca(dpruned_tree, dpruned_data[,c(14,15,16,18,19)], mode="corr") -> ppcaZ
prcomp( dpruned_data[,c(14,15,16,18,19)]) -> rpcaZ
rpcaZ$rotation = ppcaZ$L
rpcaZ$x = ppcaZ$S
rpcaZ$scale = TRUE

rpcaZ %>% fviz_screeplot(addlabels=T)
rpcaZ %>% fviz_contrib(choice="var", axes=1, sort.val="desc")
rpcaZ %>% fviz_pca_biplot( col.var="contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), repel = TRUE)

rpcaZ %>% fviz_pca_ind(repulse = T)
```

Phylogenetic ANOVA for depth
```{r phylANOVA_depth_declare, echo=F, message=F, warning=F, include=F}
z_nectopos = phylANOVA(dpruned_tree, dpruned_data$Nectosome.position, as.numeric(depth_median))
z_sex = phylANOVA(dpruned_tree, dpruned_data$Sex, as.numeric(depth_median))
z_necto = phylANOVA(dpruned_tree, dpruned_data$Nectosome, as.numeric(depth_median))
z_nectotype = phylANOVA(dpruned_tree, dpruned_data$Nectophores, as.numeric(depth_median))
z_palp = phylANOVA(dpruned_tree, dpruned_data$Palpons, as.numeric(depth_median))
z_tentilla = phylANOVA(dpruned_tree, dpruned_data$Tentilla, as.numeric(depth_median))
z_float = phylANOVA(dpruned_tree, dpruned_data$Pneumatophore, as.numeric(depth_median))
```
Each phylogenetic ANOVA compares variance of depth (continuous variable) within and between groups clustered by their categorical biological traits.
```{r phylANOVA_depth, echo=F, message=F, warning=F}
print("Depth vs Sex Distribution")
z_sex
print("Depth vs Nectosome")
z_necto
print("Depth vs Nectophore Types and Number")
z_nectotype
print("Depth vs Nectosome Position")
z_nectopos
print("Depth vs Palpons")
z_palp
print("Depth vs Tentilla")
z_tentilla
print("Depth vs Pneumatophore")
z_float
```

PGLS - Sex distribution
```{r pgls_depth_sex, echo=F, message=F, warning=F}
dp_sex <- dpruned_data$Sex
dp_sex = as.numeric(dp_sex)
names(dp_sex) = names(depth_median)
dp_sex[dp_sex==2] = 0        # 0 = Monoecious, 1 = Dioecious
#Vx <- Vy <- Cxy <- rep(0,length(dpruned_tree$tip.label))
#pgls.Ives(dpruned_tree, dp_sex, depth_median, Vx, Vy, Cxy)
pGLS = pgls.Ives(dpruned_tree, rep(dp_sex,3), rep(depth_median,3))
phylolm(depth_median~dp_sex,data=as.data.frame(cbind(depth_median,dp_sex)),phy=dpruned_tree,model="BM",measurement_error=TRUE,boot=100)
gls(dp_sex ~ depth_median)
```

### Software versions

This manuscript was computed on `r format( Sys.time(), "%a %b %d %X %Y" )` with the following R package versions.

```{r session_summary, echo=FALSE, include=TRUE, comment=NA}
	sessionInfo()
```


## References
